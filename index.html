<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bond Valuation Calculator | CFA Institute</title>
  <meta name="description" content="Interactive bond valuation calculator demonstrating present value calculations for coupon bonds">
  
  <!-- Styles -->
  <link rel="stylesheet" href="cfa-base.css?v=20251218">
  <link rel="stylesheet" href="bond-specific.css?v=20251218">
  
  <!-- Chart.js for visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- MathJax 2.7.7 for MathML rendering - EXACT copy of dividend config -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      MathML: {
        extensions: ["content-mathml.js"]
      },
      "HTML-CSS": { 
        scale: 95,
        linebreaks: { automatic: true }
      },
      menuSettings: {
        explorer: false  // Disable MathJax accessibility explorer (prevents tabindex)
      },
      MathEvents: {
        removeElement: null  // Don't make equations focusable
      },
      skipStartupTypeset: false
    });
    
    // Aggressive tabindex removal - run multiple times to catch all MathJax elements
    function removeAllMathJaxTabindex() {
      var mathJaxElements = document.querySelectorAll('.MathJax[tabindex], .MathJax_Display[tabindex], span[id^="MathJax-Element"][tabindex]');
      mathJaxElements.forEach(function(el) {
        el.removeAttribute('tabindex');
        el.setAttribute('aria-hidden', 'true');
      });
    }
    
    // Remove tabindex after MathJax finishes initial rendering
    MathJax.Hub.Register.StartupHook("End", function () {
      MathJax.Hub.Queue(function () {
        removeAllMathJaxTabindex();
        // Run again after a delay to catch stragglers
        setTimeout(removeAllMathJaxTabindex, 100);
        setTimeout(removeAllMathJaxTabindex, 500);
        setTimeout(removeAllMathJaxTabindex, 1000);
      });
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=MML_HTMLorMML"></script>
</head>
<body>
  <noscript>
    <div style="position: fixed; top: 0; left: 0; right: 0; z-index: 9999; background: #fef2f2; border-bottom: 3px solid #b91c1c; padding: 1rem; text-align: center;">
      <strong style="color: #991b1c; font-size: 1rem;">JavaScript Required:</strong>
      <span style="color: #374151; margin-left: 0.5rem;">This calculator requires JavaScript to be enabled. Please enable JavaScript in your browser settings to use this tool.</span>
    </div>
  </noscript>
  <div class="container">
    <!-- Skip Links for Accessibility -->
    <nav role="navigation" aria-label="Skip links">
      <a href="#coupon-rate" class="skip-link">Skip to data entry</a>
      <a href="#visualizer" class="skip-link">Skip to data table</a>
    </nav>
    <main class="content">
      <!-- Card 0: Static Formula (variables only) -->
      <section class="card" id="static-equation-card">
        <div class="equation-container" role="region" aria-label="General bond pricing formula">
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="block" role="math">
            <mrow>
              <msub>
                <mi mathcolor="#b95b1d">PV</mi>
                <mtext mathcolor="#b95b1d">Coupon bond</mtext>
              </msub>
              <mo>=</mo>

              <mfrac linethickness="1.2px">
                <mi mathvariant="bold" mathcolor="#3c6ae5">PMT</mi>
                <mrow class="denominator-r">
                  <mi mathcolor="#7a46ff">r</mi>
                </mrow>
              </mfrac>

              <mo>×</mo>

              <mrow>
                <mo fence="true" stretchy="true" symmetric="true">[</mo>
                <mrow>
                  <mn>1</mn>
                  <mo>−</mo>
                  <mfrac>
                    <mn>1</mn>
                    <msup>
                      <mrow>
                        <mo>(</mo>
                        <mn>1</mn>
                        <mo>+</mo>
                        <mi mathcolor="#7a46ff">r</mi>
                        <mo>)</mo>
                      </mrow>
                      <mi mathcolor="#15803d">T</mi>
                    </msup>
                  </mfrac>
                </mrow>
                <mo fence="true" stretchy="true" symmetric="true">]</mo>
              </mrow>

              <mo>+</mo>

              <mfrac>
                <mi mathcolor="#0079a6" mathvariant="bold">FV</mi>
                <msup>
                  <mrow>
                    <mo>(</mo>
                    <mn>1</mn>
                    <mo>+</mo>
                    <mi mathcolor="#7a46ff">r</mi>
                    <mo>)</mo>
                  </mrow>
                  <mi mathcolor="#15803d">T</mi>
                </msup>
              </mfrac>
            </mrow>
          </math>
        </div>
      </section>
      
      <!-- Card 1: Dynamic Equation -->
<section id="equation-card" class="card">
  <h4 class="card-title">Bond Valuation Equation</h4>
  <p class="equation-intro">
    This dynamic equation gives the price of a coupon bond based on your input in the Bond Cash Flow Calculator.
  </p>
  
  <!-- Dynamic equation with actual values -->
  <div class="equation-container" role="region" aria-label="Bond valuation equation" id="dynamic-equation-container">
    <div id="dynamic-mathml-equation">
      <!-- Populated by JavaScript -->
    </div>
  </div>
</section>

      <!-- Card 2: Calculator -->
      <section class="card" id="calculator" tabindex="-1">
        <h4 class="card-title">Bond Cash Flow Calculator</h4>
          <div class="card-content">
            <!-- Instructional note -->
            <p class="input-instructions" style="font-size: 0.875rem; color: var(--color-gray-600); margin-bottom: 1rem;">
              Enter your bond details below. The calculations and visualizations will update automatically as you change the values.
            </p>
            
            <!-- Static info row -->
            <div class="info-box">
              <div class="info-item">
                <span class="info-label">Face value:</span>
                <span class="info-value">$100.00</span>
              </div>
              <div class="info-item">
                <span class="info-label">Payment frequency:</span>
                <span class="info-value">Annual</span>
              </div>
            </div>

            <!-- Input controls -->
            <div class="input-section">
              <p class="sr-only" id="inputHelp">
                Enter values and the calculator updates results and the chart automatically.
              </p>

              <div class="input-group-inline">
                <div class="input-inline">
                  <label for="coupon-rate" class="input-label-inline">
                    Coupon rate (<span style="font-style: italic;">c</span>):
                  </label>
                  <div class="input-with-suffix-inline">
                    <input 
                      type="number" 
                      id="coupon-rate" 
                      class="input-field-inline"
                      min="0" max="10" step="0.1" value="8.6">
                    <span class="input-suffix-inline" id="coupon-rate-suffix" aria-hidden="true">%</span>
                  </div>
                </div>

                <div class="input-inline">
                  <label for="ytm" class="input-label-inline">
                    Yield-to-maturity (<span style="color: #7a46ff; font-style: italic;">r</span>):
                  </label>
                  <div class="input-with-suffix-inline">
                    <input 
                      type="number" 
                      id="ytm" 
                      class="input-field-inline"
                      min="0" max="10" step="0.1" value="6.5">
                    <span class="input-suffix-inline" id="ytm-suffix" aria-hidden="true">%</span>
                  </div>
                </div>

                <div class="input-inline">
                  <label for="years" class="input-label-inline">
                    Years to maturity (<span style="color: #15803d; font-style: italic;">T</span>):
                  </label>
                  <div class="input-with-suffix-inline">
                    <input 
                      type="number" 
                      id="years" 
                      class="input-field-inline"
                      min="1" max="5" step="1" value="5">
                    <span class="input-suffix-inline" id="years-suffix" aria-hidden="true">&nbsp;</span>
                  </div>
                </div>
              </div>

              <!-- Validation summary -->
              <div id="validation-summary" class="validation-summary" role="alert" tabindex="-1" aria-live="assertive" style="display: none;">
                <div class="validation-title">Please correct the following:</div>
                <ul id="validation-list"></ul>
              </div>
            </div>
          </div>
        </section>

      <!-- Card 3: Visualizer (Full Width) -->
      <section class="card" id="visualizer" tabindex="-1">
        <h4 class="card-title">Bond Cash Flows</h4>
        <div class="card-content">
          <!-- View toggle buttons -->
          <div class="view-controls">
            <div class="legend" id="chart-legend" role="list">
              <span class="legend-item" role="listitem">
                <span class="legend-color" style="background-color: var(--color-bond-purchase);"></span>
                Present value of bond <span style="font-style: normal; color: inherit;">(<span style="color: #b95b1d;">PV</span>)</span>
              </span>
              <span class="legend-item" role="listitem">
                <span class="legend-color" style="background-color: var(--color-bond-coupon);"></span>
                Coupon payment <span style="font-style: normal; color: inherit;">(<span style="color: #3c6ae5;">PMT</span>)</span>
              </span>
              <span class="legend-item" role="listitem">
                <span class="legend-color" style="background-color: var(--color-bond-face);"></span>
                Principal repayment <span style="font-style: normal; color: inherit;">(<span style="color: #0079a6;">FV</span>)</span>
              </span>
              <span class="legend-item" role="listitem">
                <span class="legend-color legend-dashed-line" style="border-bottom: 2px dashed var(--color-purple-bold); background: none; width: 2rem; height: 0; border-left: none; border-right: none; border-top: none;"></span>
                Yield-to-maturity <span style="font-style: normal; color: inherit;">(<span style="color: #7a46ff; font-style: italic;">r</span> = <span id="ytm-value-display" style="color: #7a46ff; font-weight: 600;">6.50%</span>)</span>
              </span>
            </div>
            
            <div class="button-group" role="toolbar">
              <button id="chart-view-btn" class="toggle-btn active" aria-pressed="true">
                Chart
              </button>
              <button id="table-view-btn" class="toggle-btn" aria-pressed="false">
                Table
              </button>
            </div>
            <p id="chart-helper-text" class="text-xs text-gray-500" style="display: none; margin-top: 0.5rem;">
              Chart view is not available at narrow screen widths. Showing table view.
            </p>
          </div>

          <!-- Screen reader announcement for view changes -->
          <div class="sr-only" aria-live="polite" aria-atomic="true" id="view-announcement"></div>

          <!-- Chart title for aria-labelledby -->
          <h4 id="bond-chart-title" class="sr-only">Bond cash flows over time</h4>

          <!-- Chart container -->
          <div id="chart-container" class="chart-wrapper" 
               role="region" 
               aria-labelledby="bond-chart-title"
               tabindex="-1">
            <canvas id="bond-chart"></canvas>
          </div>

          <!-- Table container -->
          <div id="table-container" class="table-wrapper" style="display: none;"
               role="region"
               tabindex="-1">
            <table id="cash-flow-table" class="data-table" aria-describedby="table-note">
              <!-- Populated by JavaScript -->
            </table>
            <p id="table-note" class="table-note">
              Note: Negative values indicate cash outflows (money paid out).
            </p>
          </div>
        </div>
      </section>

      <!-- Card 2: Results & Analysis -->
      <section class="card" id="results-card">
        <h4 class="card-title">Results and Analysis</h4>
        <div class="card-content">
          <div id="results-content">
            <!-- Populated by JavaScript -->
            <noscript>
              <div style="padding: 2rem; text-align: center; background: #fef2f2; border: 2px solid #b91c1c; border-radius: 0.5rem;">
                <h5 style="color: #991b1c; margin-bottom: 1rem; font-size: 1.125rem;">JavaScript Required</h5>
                <p style="color: #374151; line-height: 1.6; margin-bottom: 0.75rem;">
                  This bond calculator is an interactive tool that requires JavaScript to function.
                </p>
                <p style="color: #374151; line-height: 1.6; font-size: 0.875rem;">
                  Please enable JavaScript in your browser settings to:
                </p>
                <ul style="text-align: left; margin: 1rem auto; max-width: 20rem; color: #374151; font-size: 0.875rem; line-height: 1.6;">
                  <li>Calculate bond prices and cash flows</li>
                  <li>View interactive charts and tables</li>
                  <li>Explore dynamic equations</li>
                  <li>Adjust parameters in real-time</li>
                </ul>
              </div>
            </noscript>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- JavaScript Modules -->
  <script type="module" src="calculator.js?v=20251218"></script>
  <script>
  // Simple MathML support check
  const supportsMathML = CSS.supports('math-style: normal');

  if (!supportsMathML) {
    // Hide MathML, show fallback
    const mathml = document.getElementById('mathml-equation');
    const fallback = document.getElementById('html-equation');
    if (mathml && fallback) {
      mathml.hidden = true;
      fallback.hidden = false;
    }
  }
</script>

</body>
</html>